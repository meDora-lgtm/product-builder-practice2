/**
 * i18n Translations
 */
const translations = {
  ko: {
    app_title: "ÏÑ∏Í≥Ñ ÎåÄÌïôÍµê ÏÉÅÏúÑ 1000 ÌÉêÏÉâÍ∏∞",
    app_desc: "Ïó∞ÎèÑ ÏÑ†ÌÉù ¬∑ Í≤ÄÏÉâ ¬∑ Íµ≠Í∞Ä ÌïÑÌÑ∞ ¬∑ Ï†ïÎ†¨ ¬∑ ÌéòÏù¥ÏßÄÎ°ú ÏÑ∏Í≥Ñ ÎåÄÌïôÍµê ÏÉÅÏúÑ 1000Í∞úÎ•º Ï°∞ÌöåÌï©ÎãàÎã§",
    btn_reload: "Îç∞Ïù¥ÌÑ∞ ÏÉàÎ°úÍ≥†Ïπ®",
    btn_reset: "ÌïÑÌÑ∞ Ï¥àÍ∏∞Ìôî",
    btn_apply: "Ï°∞Ìöå",
    filter_title: "Ï°∞Ìöå Ï°∞Í±¥",
    shortcut_enter: "Îã®Ï∂ïÌÇ§ Enter Ï°∞Ìöå",
    shortcut_search: "Í≤ÄÏÉâ Ìè¨Ïª§Ïä§",
    data_notice: "Í≥µÍ∞ú CSV Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨ÏôÄÏÑú Î≥¥Ïó¨Ï£ºÎäî Îç∞Î™® ÌéòÏù¥ÏßÄÏûÖÎãàÎã§. (Top 1000 ÌëúÏãúÎäî ÏÑ†ÌÉùÌïú Ïó∞ÎèÑ Í∏∞Ï§Ä)",
    label_search: "Í≤ÄÏÉâ",
    label_search_hint: "ÌïôÍµêÎ™Ö/Íµ≠Í∞Ä",
    label_year: "Ïó∞ÎèÑ",
    label_year_hint: "Îç∞Ïù¥ÌÑ∞ Ïó∞ÎèÑ",
    label_country: "Íµ≠Í∞Ä",
    label_country_hint: "ÏÑ†ÌÉù",
    label_sort: "Ï†ïÎ†¨",
    label_sort_hint: "Í∏∞Î≥∏: ÏÑ∏Í≥ÑÎû≠ÌÇπ",
    label_page: "ÌéòÏù¥ÏßÄ Îãπ",
    label_page_hint: "ÌëúÏãú Í∞úÏàò",
    label_current: "ÌòÑÏû¨ Ï°∞Í±¥",
    label_current_hint: "ÏûêÎèô ÏöîÏïΩ",
    msg_loading: "Îç∞Ïù¥ÌÑ∞ Î∂àÎü¨Ïò§Îäî Ï§ë‚Ä¶",
    msg_wait: "ÎÑ§Ìä∏ÏõåÌÅ¨ ÏÉÅÌô©Ïóê Îî∞Îùº 1~3Ï¥à Í±∏Î¶¥ Ïàò ÏûàÏñ¥Ïöî",
    source_credit: "Îç∞Ïù¥ÌÑ∞ Ï∂úÏ≤ò: CWUR Í≥µÍ∞ú CSV",
    result_title: "Ï°∞Ìöå Í≤∞Í≥º",
    meta_year: "Ïó∞ÎèÑ",
    meta_shown: "ÌëúÏãúÎê®",
    meta_total: "Ï†ÑÏ≤¥",
    th_rank: "ÏÑ∏Í≥ÑÎû≠ÌÇπ",
    th_uni: "ÎåÄÌïôÍµê",
    th_country: "Íµ≠Í∞Ä",
    th_score: "Ï†êÏàò",
    msg_empty: "Ï°∞Í±¥Ïóê ÎßûÎäî Í≤∞Í≥ºÍ∞Ä ÏóÜÏñ¥Ïöî.",
    btn_prev: "Ïù¥Ï†Ñ",
    btn_next: "Îã§Ïùå",
    page_label: "ÌéòÏù¥ÏßÄ",
    tip_prefix: "Tip:",
    tip_suffix: "Î°ú Í≤ÄÏÉâÏ∞Ω Ìè¨Ïª§Ïä§",
    footer_note: "* Ïù¥ ÌéòÏù¥ÏßÄÎäî ÏòàÏãúÏö©Ïù¥Î©∞, ‚ÄúÏµúÏã† 2025/2026 Top1000‚ÄùÏùÑ Ïì∞Î†§Î©¥ Î≥ÑÎèÑ Îç∞Ïù¥ÌÑ∞ ÏÜåÏä§Î•º Ïó∞Í≤∞Ìï¥Ïïº Ìï©ÎãàÎã§.",
    opt_all: "Ï†ÑÏ≤¥",
    sort_rank_asc: "ÏÑ∏Í≥ÑÎû≠ÌÇπ ‚Üë",
    sort_rank_desc: "ÏÑ∏Í≥ÑÎû≠ÌÇπ ‚Üì",
    sort_score_desc: "Ï†êÏàò ‚Üì",
    sort_name_asc: "ÌïôÍµêÎ™Ö A‚ÜíZ",
    msg_data_ready: "Îç∞Ïù¥ÌÑ∞ Ï§ÄÎπÑ ÏôÑÎ£å",
    msg_render: "ÌÖåÏù¥Î∏îÏùÑ Î†åÎçîÎßÅ Ï§ë‚Ä¶",
    national_rank: "Íµ≠Í∞Ä ÎÇ¥ ÏàúÏúÑ",
    label_partnership: "Ï†úÌú¥ Î¨∏Ïùò",
    label_partnership_hint: "Formspree",
    placeholder_name: "ÏÑ±Ìï® / Í∏∞ÏóÖÎ™Ö",
    placeholder_email: "Ïù¥Î©îÏùº Ï£ºÏÜå",
    placeholder_message: "Î¨∏Ïùò ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî",
    btn_send: "Î¨∏ÏùòÌïòÍ∏∞",
    comments_title: "ÎåìÍ∏Ä",
    label_ads: "Í¥ëÍ≥†",
    // ÏäπÏù∏ ÏµúÏ†ÅÌôî Î¨∏Íµ¨ (Í≥†Í∏âÌôî)
    about_title: "ÏÑ∏Í≥Ñ Î™ÖÎ¨∏ÎåÄ Ï°∞Ìöå Î∞è ÌïôÏà† Ï†ïÎ≥¥ Í∞ÄÏù¥Îìú",
    about_desc: "Î≥∏ ÌîåÎû´ÌèºÏùÄ Ï†Ñ ÏÑ∏Í≥Ñ Ïú†Î™Ö ÎåÄÌïôÍµêÎì§Ïùò ÌïôÎ¨∏Ï†Å ÏÑ±Í≥ºÏôÄ Í∏ÄÎ°úÎ≤å ÏúÑÏÉÅÏùÑ ÌïúÎààÏóê ÌååÏïÖÌïòÍ≥†, ÍµêÏú° Ï†ïÎ≥¥ Ï°∞ÌöåÎ•º ÏàòÏõîÌïòÍ≤å ÎèïÍ∏∞ ÏúÑÌï¥ Íµ¨Ï∂ïÎêú Ï†ÑÎ¨∏ ÌÉêÏÉâ ÎèÑÍµ¨ÏûÖÎãàÎã§. CWUR Îç∞Ïù¥ÌÑ∞Î•º Î∞îÌÉïÏúºÎ°ú Í≥µÏã†Î†• ÏûàÎäî Îû≠ÌÇπ Ï†ïÎ≥¥Î•º Ï†úÍ≥µÌïòÎ©∞, ÎØ∏ÎûòÎ•º Ï§ÄÎπÑÌïòÎäî ÌïôÏÉùÎì§Í≥º Ïó∞Íµ¨ÏûêÎì§ÏóêÍ≤å ÏµúÏ†ÅÌôîÎêú Îç∞Ïù¥ÌÑ∞ Î∂ÑÏÑù ÌôòÍ≤ΩÏùÑ Ï†úÍ≥µÌï©ÎãàÎã§.",
    policy_privacy: "Í∞úÏù∏Ï†ïÎ≥¥Ï≤òÎ¶¨Î∞©Ïπ®",
    policy_terms: "Ïù¥Ïö©ÏïΩÍ¥Ä",
    privacy_content: "Î≥∏ ÏÇ¨Ïù¥Ìä∏Îäî ÏÇ¨Ïö©ÏûêÏùò Í∞úÏù∏Ï†ïÎ≥¥Î•º ÏßÅÏ†ë ÏàòÏßëÌïòÏßÄ ÏïäÏäµÎãàÎã§. Îã§Îßå Í¥ëÍ≥† Î∞è ÌÜµÍ≥Ñ Î∂ÑÏÑùÏùÑ ÏúÑÌï¥ Google AdSense Î∞è DisqusÏùò Ïø†ÌÇ§Í∞Ä ÏÇ¨Ïö©Îê† Ïàò ÏûàÏäµÎãàÎã§.",
    terms_content: "Ï†úÍ≥µÎêòÎäî Î™®Îì† ÏàúÏúÑ Îç∞Ïù¥ÌÑ∞Îäî Ï∞∏Í≥†Ïö©Ïù¥Î©∞, ÏµúÏã† Ï†ïÎ≥¥Îäî Í∞Å ÍµêÏú° Í∏∞Í¥ÄÏùò Í≥µÏãù Î∞úÌëúÎ•º Í∏∞Ï§ÄÏúºÎ°ú Ìï©ÎãàÎã§.",
    copyright: "¬© 2026 World Uni Explorer. Empowering Global Education.",
    btn_close: "Îã´Í∏∞"
  },
  en: {
    app_title: "World University Top 1000 Explorer",
    app_desc: "Explore top 1000 universities by year, search, country filter, sort, and pagination",
    btn_reload: "Reload Data",
    btn_reset: "Reset Filters",
    btn_apply: "Apply",
    filter_title: "Filters",
    shortcut_enter: "Press Enter to search",
    shortcut_search: "Focus search",
    data_notice: "Demo page using public CSV data. (Top 1000 based on selected year)",
    label_search: "Search",
    label_search_hint: "Name/Country",
    label_year: "Year",
    label_year_hint: "Data Year",
    label_country: "Country",
    label_country_hint: "Select",
    label_sort: "Sort",
    label_sort_hint: "Default: World Rank",
    label_page: "Per Page",
    label_page_hint: "Count",
    label_current: "Current Conditions",
    label_current_hint: "Auto Summary",
    msg_loading: "Loading data...",
    msg_wait: "May take 1-3 seconds depending on network",
    source_credit: "Data Source: CWUR Public CSV",
    result_title: "Results",
    meta_year: "Year",
    meta_shown: "Shown",
    meta_total: "Total",
    th_rank: "World Rank",
    th_uni: "University",
    th_country: "Country",
    th_score: "Score",
    msg_empty: "No results found.",
    btn_prev: "Prev",
    btn_next: "Next",
    page_label: "Page",
    tip_prefix: "Tip:",
    tip_suffix: "to focus search",
    footer_note: "* This is a demo. For latest 2025/2026 data, connect to a separate source.",
    opt_all: "All",
    sort_rank_asc: "Rank Asc",
    sort_rank_desc: "Rank Desc",
    sort_score_desc: "Score Desc",
    sort_name_asc: "Name A-Z",
    msg_data_ready: "Data Ready",
    msg_render: "Rendering table...",
    national_rank: "National rank",
    label_partnership: "Partnership",
    label_partnership_hint: "Formspree",
    placeholder_name: "Name / Company",
    placeholder_email: "Email Address",
    placeholder_message: "Enter your message",
    btn_send: "Send Message",
    comments_title: "Comments",
    label_ads: "AD",
    about_title: "About Project",
    about_desc: "This project provides a comprehensive explorer for the Top 1000 World University Rankings based on CWUR data. It aims to help students, researchers, and educators analyze global academic trends and institutional performance across different years and countries.",
    policy_privacy: "Privacy Policy",
    policy_terms: "Terms of Service",
    privacy_content: "We do not directly collect or store any personal user data. However, third-party services like Google AdSense and Disqus may use cookies for ad personalization and comment functionality.",
    terms_content: "Data provided on this site is for educational and informational purposes only. While we strive for accuracy, please consult official institutional sources for definitive information.",
    copyright: "¬© 2026 World Uni Explorer. All Rights Reserved."
  },
  ja: {
    app_title: "‰∏ñÁïåÂ§ßÂ≠¶„Éà„ÉÉ„Éó1000„Ç®„ÇØ„Çπ„Éó„É≠„Éº„É©„Éº",
    app_desc: "Âπ¥Â∫¶ÈÅ∏Êäû„ÄÅÊ§úÁ¥¢„ÄÅÂõΩ„Éï„Ç£„É´„Çø„ÄÅ„ÇΩ„Éº„Éà„ÄÅ„Éö„Éº„Ç∏„É≥„Ç∞„Åß‰∏ñÁïåÂ§ßÂ≠¶„Éà„ÉÉ„Éó1000„ÇíÁÖß‰ºö„Åó„Åæ„Åô",
    btn_reload: "Îç∞Ïù¥ÌÑ∞Êõ¥Êñ∞",
    btn_reset: "Î¶¨ÏÖã",
    btn_apply: "ÈÅ©Áî®",
    filter_title: "ÁÖß‰ºöÊù°‰ª∂",
    shortcut_enter: "Enter„ÅßÁÖßÌöå",
    shortcut_search: "Ê§úÁ¥¢„Éï„Ç©„Éº„Ç´„Çπ",
    data_notice: "ÂÖ¨ÈñãCSVÎç∞Ïù¥ÌÑ∞„Çí‰ΩøÁî®„Åó„ÅüÎç∞Î™®ÌéòÏù¥ÏßÄÏûÖÎãàÎã§.Ôºà„Éà„ÉÉ„Éó1000„ÅØÈÅ∏ÊäûÂπ¥Â∫¶Âü∫Ê∫ñÔºâ",
    label_search: "Ê§úÁ¥¢",
    label_search_hint: "Â§ßÂ≠¶Âêç/ÂõΩÂêç",
    label_year: "Âπ¥Â∫¶",
    label_year_hint: "Îç∞Ïù¥ÌÑ∞Âπ¥Â∫¶",
    label_country: "ÂõΩ",
    label_country_hint: "ÈÅ∏Êäû",
    label_sort: "‰∏¶„Å≥Êõø„Åà",
    label_sort_hint: "„Éá„Éï„Ç©„É´„Éà: ‰∏ñÁïåÈ†Ü‰Ωç",
    label_page: "Ë°®Á§∫‰ª∂Êï∞",
    label_page_hint: "1„Éö„Éº„Ç∏„ÅÇ„Åü„Çä",
    label_current: "ÁèæÂú®„ÅÆÊù°‰ª∂",
    label_current_hint: "Ëá™ÂãïË¶ÅÁ¥Ñ",
    msg_loading: "Îç∞Ïù¥ÌÑ∞„ÇíË™≠„ÅøËæº„Åø‰∏≠...",
    msg_wait: "ÎÑ§Ìä∏ÏõåÌÅ¨Áä∂Ê≥Å„Å´„Çà„Çä1„Äú3Áßí„Åã„Åã„ÇãÂ†¥Âêà„Åå„ÅÇ„Çä„Åæ„Åô",
    source_credit: "Îç∞Ïù¥ÌÑ∞Âá∫ÂÖ∏: CWUR ÂÖ¨Èñã CSV",
    result_title: "ÁÖß‰ºöÁµêÊûú",
    meta_year: "Âπ¥Â∫¶",
    meta_shown: "Ë°®Á§∫‰∏≠",
    meta_total: "ÂÖ®‰Ωì",
    th_rank: "‰∏ñÁïåÈ†Ü‰Ωç",
    th_uni: "Â§ßÂ≠¶",
    th_country: "ÂõΩ",
    th_score: "„Çπ„Ç≥„Ç¢",
    msg_empty: "Ë©≤ÂΩì„Åô„ÇãÁµêÊûú„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ",
    btn_prev: "Ââç„Å∏",
    btn_next: "Ê¨°„Å∏",
    page_label: "„Éö„Éº„Ç∏",
    tip_prefix: "Tip:",
    tip_suffix: "„ÅßÊ§úÁ¥¢Á™ì„Å´„Éï„Ç©„Éº„Ç´„Çπ",
    footer_note: "* „Åì„ÅÆ„Éö„Éº„Ç∏„ÅØ„Éá„É¢Áî®„Åß„Åô„ÄÇÊúÄÊñ∞„ÅÆ2025/2026„Éá„Éº„Çø„Çí‰ΩøÁî®„Åô„Çã„Å´„ÅØÂà•ÈÄî„ÇΩ„Éº„Çπ„ÅåÂøÖË¶Å„Åß„Åô„ÄÇ",
    opt_all: "„Åô„Åπ„Å¶",
    sort_rank_asc: "‰∏ñÁïåÈ†Ü‰Ωç ‚Üë",
    sort_rank_desc: "‰∏ñÁïåÈ†ÜÏúÑ ‚Üì",
    sort_score_desc: "„Çπ„Ç≥„Ç¢ ‚Üì",
    sort_name_asc: "Â§ßÂ≠¶Âêç A‚ÜíZ",
    msg_data_ready: "Ê∫ñÂÇôÂÆå‰∫Ü",
    msg_render: "Î†åÎã§ÎßÅ‰∏≠...",
    national_rank: "ÂõΩÂÜÖÈ†Ü‰Ωç",
    label_partnership: "ÊèêÊê∫„ÅäÂïè„ÅÑÂêà„Çè„Åõ",
    label_partnership_hint: "Formspree",
    placeholder_name: "„ÅäÂêçÂâç / ‰ºÅÊ•≠Âêç",
    placeholder_email: "„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ",
    placeholder_message: "„ÅäÂïè„ÅÑÂêà„Çè„ÅõÂÜÖÂÆπ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ",
    btn_send: "ÈÄÅ‰ø°„Åô„Çã",
    comments_title: "„Ç≥„É°„É≥„Éà",
    label_ads: "Â∫ÉÂëä",
    about_title: "„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Å´„Å§„ÅÑ„Å¶",
    about_desc: "„Åì„ÅÆ„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅØ„ÄÅCWURÔºàCenter for World University RankingsÔºâ„ÅÆ„Éá„Éº„Çø„ÇíÊ¥ªÁî®„Åó„ÄÅ‰∏ñÁïå‰∏≠„ÅÆÂ§ßÂ≠¶„ÅÆÁ´∂‰∫âÂäõ„ÇÑÂ≠¶Ë°ìÁöÑÊàêÊûú„ÇíÁ∞°Âçò„Å´Êé¢Á¥¢„Åß„Åç„Çã„Çà„ÅÜ„Å´Ë®≠Ë®à„Åï„Çå„Å¶„ÅÑ„Åæ„Åô„ÄÇ„É¶„Éº„Ç∂„Éº„ÅØÂπ¥Â∫¶Âà•„ÅÆÈ†Ü‰ΩçÂ§âÂãï„ÇíÁ¢∫Ë™ç„Åó„ÄÅÂõΩÂà•„ÅÆ„Éï„Ç£„É´„Çø„É™„É≥„Ç∞„ÇíÈÄö„Åò„Å¶ËààÂë≥„ÅÆ„ÅÇ„ÇãÊïôËÇ≤Ê©üÈñ¢„ÅÆÊÉÖÂ†±„ÇíÂæó„Çã„Åì„Å®„Åå„Åß„Åç„Åæ„Åô„ÄÇ",
    policy_privacy: "„Éó„É©„Ç§„Éê„Ç∑„Éº„Éù„É™„Ç∑„Éº",
    policy_terms: "Âà©Áî®Ë¶èÁ¥Ñ",
    privacy_content: "ÂΩì„Çµ„Ç§„Éà„ÅØ„É¶„Éº„Ç∂„Éº„ÅÆÂÄã‰∫∫ÊÉÖÂ†±„ÇíÁõ¥Êé•ÂèéÈõÜ„Åæ„Åü„ÅØ‰øùÂ≠ò„Åó„Åæ„Åõ„Çì„ÄÇ„Åü„Å†„Åó„ÄÅGoogle AdSense„ÇÑDisqus„Å™„Å©„ÅÆÁ¨¨‰∏âËÄÖ„Çµ„Éº„Éì„Çπ„ÇíÈÄö„Åò„Å¶„ÄÅÂ∫ÉÂëä„ÅÆ„Éë„Éº„ÇΩ„Éä„É©„Ç§„Ç∫„ÇÑ„Ç≥„É°„É≥„ÉàÊ©üËÉΩÊèê‰æõ„ÅÆ„Åü„ÇÅ„Å´„ÇØ„ÉÉ„Ç≠„Éº„Åå‰ΩøÁî®„Åï„Çå„ÇãÂ†¥Âêà„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ",
    terms_content: "ÂΩì„Çµ„Ç§„Éà„ÅßÊèê‰æõ„Åï„Çå„Çã„Éá„Éº„Çø„ÅØÊïôËÇ≤ÁõÆÁöÑ„ÅÆÂèÇÁÖßÁî®„Åß„Åô„ÄÇÊ≠£Á¢∫ÊÄß„ÅÆÁ¢∫‰øù„Å´Âä™„ÇÅ„Å¶„ÅÑ„Åæ„Åô„Åå„ÄÅÊúÄÊñ∞„ÅÆÂÖ¨ÂºèÊÉÖÂ†±„ÇíÂøÖ„ÅöÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ",
    copyright: "¬© 2026 World Uni Explorer. All Rights Reserved."
  }
};

const $ = (s) => document.querySelector(s);

function setLanguage(lang) {
  const dict = translations[lang] || translations.en;
  document.querySelectorAll("[data-i18n]").forEach(el => {
    const key = el.getAttribute("data-i18n");
    if (dict[key]) {
      if (el.tagName === "INPUT" || el.tagName === "TEXTAREA") {
        el.placeholder = dict[key];
      } else {
        el.textContent = dict[key];
      }
    }
  });
  localStorage.setItem("lang", lang);
  $("#langSelect").value = lang;
}

$("#langSelect").addEventListener("change", (e) => {
  setLanguage(e.target.value);
  buildCountries(); // Update "All" option in select
  render(); // Update labels in summary chips and table
});

/**
 * Îç∞Ïù¥ÌÑ∞ ÏÜåÏä§ (Í≥µÍ∞ú Raw CSV)
 */
const DATA_URL = "https://raw.githubusercontent.com/arnaudbenard/university-ranking/master/cwurData.csv";

// App state
const state = {
  raw: [],
  year: null,
  q: "",
  country: "__ALL__",
  sort: "rank_asc",
  page: 1,
  pageSize: 50
};

function setSourceStatus(loaded, msg){
  const box = $("#sourceBox");
  const lang = localStorage.getItem("lang") || "ko";
  const dict = translations[lang];

  box.innerHTML = loaded
    ? `<div class="dot" style="animation:none; opacity:1;">
       </div>
       <div>
         <div style="color:var(--text); opacity:0.9; font-size:13px; font-weight:650;">${dict.msg_data_ready}</div>
         <div style="font-size:12px;">${msg}</div>
       </div>`
    : `<div class="dot"></div>
       <div>
         <div style="color:var(--text); opacity:0.86; font-size:13px; font-weight:650;">${dict.msg_loading}</div>
         <div style="font-size:12px;">${msg || dict.msg_wait}</div>
       </div>`;
}

// Robust-ish CSV parser (handles quotes, commas in quotes)
function parseCSV(text){
  const rows = [];
  let i = 0, field = "", row = [], inQuotes = false;
  const pushField = () => { row.push(field); field = ""; };
  const pushRow = () => { rows.push(row); row = []; };

  while (i < text.length){
    const c = text[i];

    if (inQuotes){
      if (c === '"'){
        if (text[i+1] === '"'){ field += '"'; i += 2; continue; }
        inQuotes = false; i++; continue;
      } else {
        field += c; i++; continue;
      }
    } else {
      if (c === '"'){ inQuotes = true; i++; continue; }
      if (c === ","){ pushField(); i++; continue; }
      if (c === "\r"){ i++; continue; }
      if (c === "\n"){ pushField(); pushRow(); i++; continue; }
      field += c; i++; continue;
    }
  }
  // last
  if (field.length || row.length){
    pushField(); pushRow();
  }
  return rows;
}

function toNum(v){
  const n = Number(v);
  return Number.isFinite(n) ? n : null;
}

function normalize(s){
  return (s || "").toLowerCase().trim();
}

function uniq(arr){
  return [...new Set(arr)];
}

function buildYears(){
  const years = uniq(state.raw.map(x => x.year)).sort((a,b)=>b-a);
  const sel = $("#year");
  sel.innerHTML = "";
  years.forEach(y=>{
    const opt = document.createElement("option");
    opt.value = String(y);
    opt.textContent = String(y);
    sel.appendChild(opt);
  });
  state.year = years[0] ?? null;
  sel.value = String(state.year ?? "");
}

function buildCountries(){
  const list = state.raw
    .filter(x => x.year === state.year && x.world_rank <= 1000)
    .map(x => x.country)
    .filter(Boolean);
  const countries = uniq(list).sort((a,b)=>a.localeCompare(b));
  const sel = $("#country");
  const lang = localStorage.getItem("lang") || "ko";
  const allText = translations[lang].opt_all;
  const prevVal = sel.value || "__ALL__";
  
  sel.innerHTML = `<option value="__ALL__">${allText}</option>`;
  countries.forEach(c=>{
    const opt = document.createElement("option");
    opt.value = c;
    opt.textContent = c;
    sel.appendChild(opt);
  });
  sel.value = prevVal;
}

function updateSummary(){
  const chips = $("#summaryChips");
  const lang = localStorage.getItem("lang") || "ko";
  const dict = translations[lang];
  const parts = [];

  if (state.year) parts.push({k:dict.label_year, v:String(state.year)});
  if (state.country !== "__ALL__") parts.push({k:dict.label_country, v:state.country});
  if (state.q) parts.push({k:dict.label_search, v:state.q});
  parts.push({k:dict.label_sort, v: $("#sort").selectedOptions[0].textContent});
  parts.push({k:dict.page_label, v: `${state.pageSize}/page`});

  chips.innerHTML = "";
  parts.forEach(p=>{
    const d = document.createElement("div");
    d.className = "chip";
    d.textContent = `${p.k}: ${p.v}`;
    chips.appendChild(d);
  });
}

function applyFilters(){
  const q = normalize(state.q);

  let list = state.raw.filter(x =>
    x.year === state.year &&
    x.world_rank !== null &&
    x.world_rank <= 1000
  );

  if (state.country !== "__ALL__"){
    list = list.filter(x => x.country === state.country);
  }

  if (q){
    list = list.filter(x => {
      const hay = normalize(`${x.institution} ${x.country}`);
      return hay.includes(q);
    });
  }

  // sort
  if (state.sort === "rank_asc"){
    list.sort((a,b)=>a.world_rank - b.world_rank);
  } else if (state.sort === "rank_desc"){
    list.sort((a,b)=>b.world_rank - a.world_rank);
  } else if (state.sort === "score_desc"){
    list.sort((a,b)=>(b.score ?? -1) - (a.score ?? -1) || (a.world_rank - b.world_rank));
  } else if (state.sort === "name_asc"){
    list.sort((a,b)=>String(a.institution).localeCompare(String(b.institution)));
  }

  return list;
}

function render(){
  const lang = localStorage.getItem("lang") || "ko";
  const dict = translations[lang];

  $("#loadingArea").style.display = "block";
  $("#empty").style.display = "none";
  $("#tbody").innerHTML = "";

  const list = applyFilters();
  const total = list.length;

  // pagination
  const maxPage = Math.max(1, Math.ceil(total / state.pageSize));
  state.page = Math.min(state.page, maxPage);
  const start = (state.page - 1) * state.pageSize;
  const end = start + state.pageSize;
  const pageItems = list.slice(start, end);

  $("#pageNow").textContent = String(state.page);
  $("#pageMax").textContent = String(maxPage);

  $("#metaYear").textContent = state.year ? String(state.year) : "-";
  $("#metaTotal").textContent = String(total);
  $("#metaShown").textContent = String(pageItems.length);
  $("#metaCount").textContent = `Top 1000 (${dict.result_title} ${total.toLocaleString()})`;
  $("#metaNote").textContent = total ? ` ¬∑ ${state.page} / ${maxPage} ${dict.page_label}` : "";

  $("#resultTitle").textContent = `Top 1000 ¬∑ ${state.year ?? "-"}`;

  if (!pageItems.length){
    $("#loadingArea").style.display = "none";
    $("#empty").style.display = "block";
    return;
  }

  const tbody = $("#tbody");
  for (const it of pageItems){
    const tr = document.createElement("tr");
    const scoreText = (it.score === null || it.score === undefined) ? "-" : (Math.round(it.score*100)/100).toFixed(2);

    tr.innerHTML = `
      <td><span class="rank">#${it.world_rank}</span></td>
      <td>
        <div style="font-weight:650; color:var(--text); opacity:0.94;">${escapeHTML(it.institution)}</div>
        <div style="margin-top:4px; color:var(--muted2); font-size:12px;">${dict.national_rank}: ${it.national_rank ?? "-"}</div>
      </td>
      <td><span class="pill"><b>${escapeHTML(it.country)}</b></span></td>
      <td><span class="pill"><b>${scoreText}</b> score</span></td>
    `;
    tbody.appendChild(tr);
  }

  $("#loadingArea").style.display = "none";
  updateSummary();
}

function escapeHTML(s){
  return String(s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

async function loadData(){
  const lang = localStorage.getItem("lang") || "ko";
  const dict = translations[lang];

  setSourceStatus(false, dict.msg_loading);
  try{
    const res = await fetch(DATA_URL, { cache: "no-store" });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const text = await res.text();

    const rows = parseCSV(text);
    // header
    const header = rows[0].map(h => h.trim());
    const idx = (name) => header.indexOf(name);

    const iRank = idx("world_rank");
    const iInst = idx("institution");
    const iCountry = idx("country");
    const iNat = idx("national_rank");
    const iScore = idx("score");
    const iYear = idx("year");

    if ([iRank,iInst,iCountry,iYear].some(i => i < 0)){
      throw new Error("CSV Ìó§ÎçîÍ∞Ä ÏòàÏÉÅÍ≥º Îã§Î¶ÖÎãàÎã§.");
    }

    const parsed = [];
    for (let r=1; r<rows.length; r++){
      const row = rows[r];
      if (!row || row.length < header.length) continue;

      const world_rank = toNum(row[iRank]);
      const year = toNum(row[iYear]);
      if (!world_rank || !year) continue;

      parsed.push({
        world_rank,
        institution: row[iInst] || "",
        country: row[iCountry] || "",
        national_rank: toNum(row[iNat]),
        score: toNum(row[iScore]),
        year
      });
    }

    state.raw = parsed;

    buildYears();
    buildCountries();

    // Ï¥àÍ∏∞ ÏÑ∏ÌåÖ
    state.page = 1;
    state.pageSize = Number($("#pageSize").value);
    state.sort = $("#sort").value;

    setSourceStatus(true, `Ï¥ù ${state.raw.length.toLocaleString()} rows Î°úÎìú ÏôÑÎ£å`);
    render();
  } catch (e){
    setSourceStatus(true, `Î°úÎìú Ïã§Ìå®: ${e.message}`);
    $("#empty").style.display = "block";
    $("#empty").innerHTML = `Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§ÏßÄ Î™ªÌñàÏñ¥Ïöî üòø<br/>Ïù∏ÌÑ∞ÎÑ∑ Ïó∞Í≤∞ÏùÑ ÌôïÏù∏ÌïòÍ±∞ÎÇò, Îç∞Ïù¥ÌÑ∞ URLÏùÑ Î∞îÍøîÏ£ºÏÑ∏Ïöî.`;
  }
}

// events
$("#btnApply").addEventListener("click", ()=>{
  state.page = 1;
  buildCountries(); // year Î≥ÄÍ≤Ω ÌõÑ Íµ≠Í∞Ä Î¶¨Ïä§Ìä∏ ÏóÖÎç∞Ïù¥Ìä∏
  render();
});

$("#btnReset").addEventListener("click", ()=>{
  state.q = "";
  state.country = "__ALL__";
  state.sort = "rank_asc";
  state.page = 1;
  state.pageSize = 50;

  $("#q").value = "";
  $("#country").value = "__ALL__";
  $("#sort").value = "rank_asc";
  $("#pageSize").value = "50";

  buildCountries();
  render();
});

$("#btnReload").addEventListener("click", loadData);

$("#q").addEventListener("input", (e)=>{ state.q = e.target.value; });
$("#q").addEventListener("keydown", (e)=>{
  if (e.key === "Enter"){
    state.page = 1;
    render();
  }
});

$("#year").addEventListener("change", (e)=>{
  state.year = Number(e.target.value);
  state.page = 1;
  buildCountries();
  render();
});

$("#country").addEventListener("change", (e)=>{
  state.country = e.target.value;
  state.page = 1;
  render();
});

$("#sort").addEventListener("change", (e)=>{
  state.sort = e.target.value;
  state.page = 1;
  render();
});

$("#pageSize").addEventListener("change", (e)=>{
  state.pageSize = Number(e.target.value);
  state.page = 1;
  render();
});

$("#prev").addEventListener("click", ()=>{
  state.page = Math.max(1, state.page - 1);
  render();
});
$("#next").addEventListener("click", ()=>{
  state.page = state.page + 1;
  render();
});

// shortcut: "/" focuses search
window.addEventListener("keydown", (e)=>{
  if (e.key === "/" && document.activeElement?.tagName !== "INPUT"){
    e.preventDefault();
    $("#q").focus();
  }
});

/**
 * Theme Toggle logic
 */
const themeToggle = $("#themeToggle");
const themeIcon = $("#themeIcon");

function setTheme(theme) {
  document.documentElement.setAttribute("data-theme", theme);
  localStorage.setItem("theme", theme);
  themeIcon.textContent = theme === "dark" ? "üåô" : "‚òÄÔ∏è";
}

themeToggle.addEventListener("click", () => {
  const currentTheme = document.documentElement.getAttribute("data-theme") || "dark";
  const newTheme = currentTheme === "dark" ? "light" : "dark";
  setTheme(newTheme);
});

// Init theme
const savedTheme = localStorage.getItem("theme") || (window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light");
setTheme(savedTheme);

// Init language
const savedLang = localStorage.getItem("lang") || "ko";
setLanguage(savedLang);

// init
loadData();

/**
 * Modal Logic
 */
const modalOverlay = $("#modalOverlay");
const modalContent = $("#modalContent");
const modalTitle = $("#modalTitle");
const modalBody = $("#modalBody");

function openModal(type) {
  const lang = localStorage.getItem("lang") || "ko";
  const dict = translations[lang];
  
  if (type === "privacy") {
    modalTitle.textContent = dict.policy_privacy;
    modalBody.textContent = dict.privacy_content;
  } else {
    modalTitle.textContent = dict.policy_terms;
    modalBody.textContent = dict.terms_content;
  }
  
  modalOverlay.classList.add("active");
  modalContent.classList.add("active");
  document.body.style.overflow = "hidden"; // scroll lock
}

function closeModal() {
  modalOverlay.classList.remove("active");
  modalContent.classList.remove("active");
  document.body.style.overflow = "";
}

$("#openPrivacy").addEventListener("click", () => openModal("privacy"));
$("#openTerms").addEventListener("click", () => openModal("terms"));
$("#closeModal").addEventListener("click", closeModal);
$("#modalOverlay").addEventListener("click", closeModal);
$("#btnModalClose").addEventListener("click", closeModal);

/**
 * Fun Interaction: Visual feedback on Apply
 */
$("#btnApply").addEventListener("mousedown", () => {
  $("#btnApply").style.transform = "scale(0.95)";
});
$("#btnApply").addEventListener("mouseup", () => {
  $("#btnApply").style.transform = "scale(1)";
});
